## INSERT, DELETE and UPDATE
### and [Returning Data](https://www.postgresql.org/docs/current/dml-returning.html#DML-RETURNING) from modified rows

- create a simple table for the demo
```sql
-- drop table if exists insert_tests;
create table insert_tests (
 id serial,
 t text,
 i integer,
 ts timestamptz not null default current_timestamp
);
```
- [INSERT](https://www.postgresql.org/docs/current/sql-insert.html) a few rows into it using [VALUES](https://www.postgresql.org/docs/current/queries-values.html) and SELECT
```sql
insert into insert_tests (t, i) 
 values ('ТУЕС', 3);
 
insert into insert_tests (t, i) 
 values ('ТУ София', 4), ('УНСС', 5);
 
insert into insert_tests (t, i)
 select c.name, c.id from class_a.category c
 where c.id > 3;

select * from insert_tests;
```
- [DELETE](https://www.postgresql.org/docs/current/sql-delete.html) a few rows (these that have `оду` in their name (i.e. Продукти)
```sql
delete from insert_tests
where t ~* 'оду';
-- the same one returning the deleted rows
delete from insert_tests
where t ~* 'оду'
returning id, t;
-- and as a data-modifying CTE
with t as
(
 delete from insert_tests
 where t ~* 'оду'
 returning id, t
)
select count(*) from t;
```
- a couple of [UPDATE](https://www.postgresql.org/docs/current/sql-update.html) examples
```sql
update insert_tests set t = 'Пресни зеленчуци'
where t = 'Зеленчуци';
 
update insert_tests set t = 'Тестени варива'
where t = 'Варива' and id = 4;
```
### Final thoughts
- You may live a better life without DELETE and UPDATE using insert-only workflow instead. AI generated:  
> An "insert-only workflow" is a process where new data is always added to a system via an
> INSERT command, rather than by modifying existing records with UPDATE or DELETE commands.
> This approach creates a complete history of all data changes, which can be useful for auditing, historical analysis,
> and some performance optimization scenarios, particularly in databases. In practice, this often involves creating
> a new version of a record with updated information, while the old version remains for historical context,
> as explained in this CYBERTEC PostgreSQL [article](https://www.cybertec-postgresql.com/en/insert-only-data-modelling-to-smooth-peaks-on-slow-disks/).  
  
<br/>

> [!WARNING]
> Beware of [SQL injection](https://en.wikipedia.org/wiki/SQL_injection)!<br/>  
> SQL Injection is a common security vulnerability that arises from letting attacker-supplied data become SQL code. **This happens when programmers assemble SQL queries either by string interpolation or by concatenating SQL commands with user supplied data**.<br/>
  
A simple illustration:   
```sql
'select <whatever> from <a table> where id=' -- a SQL template to concatenate with the user input

23 -- user input. The result would be
select <whatever> from <a table> where id=23 -- works happily and delivers the expected result

1; drop table users; -- user input. The result would be
select <whatever> from <a table> where id=1; drop table <an important table> -- and a disaster follows
```
