#### Food deliveries data model
#### ... and something very important is *wrong*
```sql
-- drop schema if exists fd cascade;
create schema if not exists fd;

create table fd.unit (
 unit_id smallint not null primary key,
 name text not null,
 misc jsonb default '{}' not null
);

create table fd.course (
 course_id serial primary key not null,
 name text not null,
 misc jsonb default '{}' not null
);

----------------------------------------
-- Old school style ENUM alternative
----------------------------------------

insert into fd.course (course_id, name) values (1, 'appetizer'), (2, 'soup'), (3, 'entrée'), (4, 'dessert'), (5, 'beverage');
insert into fd.unit (unit_id, name) values (1,'Брой'), (2,'Грам'), (3,'Литър'), (4,'Метър');

----------------------------------------

create table fd.product (
 product_id serial primary key not null,
 name text not null,
 unit_id smallint not null references fd.unit(unit_id), 
 misc jsonb default '{}' not null
);

create table fd.dish (
 dish_id serial primary key not null,
 name text not null,
 course_id integer not null references fd.course(course_id),
 vegetarian boolean not null default false,
 price numeric not null,
 notes text, -- maybe a few words about what this dish is
 misc jsonb default '{}' not null
);

create table fd.dish_product (
 dish_id integer not null references fd.dish(dish_id),
 product_id integer not null references fd.product(product_id),
 quantity numeric not null, 
 misc jsonb default '{}' not null,
 constraint dish_product_pk primary key (dish_id, product_id)
);

----------------------------------------
-- Next working day machinery
----------------------------------------

create table fd.nw_days (
 nw_date date not null primary key,
 notes text
);

insert into fd.nw_days (nw_date)
values
 ('2025-01-01'), ('2026-01-01'), ('2027-01-01'),
 ('2025-03-03'), ('2026-03-03'), ('2027-03-03'),
 ('2025-04-20'), ('2026-04-12'), ('2027-04-30'), -- Easter
 ('2025-05-01'), ('2026-05-01'), ('2027-05-01'),
 ('2025-05-06'), ('2026-05-06'), ('2027-05-06'),
 ('2025-05-24'), ('2026-05-24'), ('2027-05-24'),
 ('2025-09-06'), ('2026-09-06'), ('2027-09-06'),
 ('2025-09-22'), ('2026-09-22'), ('2027-09-22'),
 ('2025-12-24'), ('2026-12-24'), ('2027-12-24'), -- Christmas, 3 days
 ('2025-12-25'), ('2026-12-25'), ('2027-12-27'),
 ('2025-12-26'), ('2026-12-26'), ('2027-12-28');

 
create or replace function fd.next_wd(since date) returns date 
return
(
 select since + run_off
 from generate_series(1, 10) as t(run_off)
 where extract('isodow' from since + run_off) < 6
   and not exists (select from public.nw_days where nw_date = since + run_off)
 order by run_off limit 1
);

----------------------------------------

create table fd.menuitem (
 menuitem_id serial primary key not null,
 effective_date date not null default fd.next_wd(current_date),
 time_created timestamptz not null default current_timestamp,
 dish_id integer not null references fd.dish(dish_id),
 price numeric not null,
 misc jsonb default '{}' not null
);

create table fd.client (
 client_id serial primary key not null,
 name text not null,
 delivery_address text not null,
 telephone text not null,
 email text not null,
 misc jsonb default '{}' not null
);

create table fd.order (
 order_id serial primary key not null,
 effective_date date not null default fd.next_wd(current_date),
 client_id integer not null references fd.client(client_id),
 delivery_time timetz,
 delivery_address text,     -- client address override
 price numeric,             -- price override
 misc jsonb default '{}' not null 
);

----------------------------------------
-- And a true ENUM type
----------------------------------------

create type fd.order_event as
enum (
 'confirmed', 'cancelled', 'shipped', 'delivered',
 'returned', 'in-transit', 'damaged', 'stolen', 'lost'
);

----------------------------------------

create table fd.order_status (
 order_id integer not null references fd.order(order_id),
 status_event fd.order_event not null,
 effective_time timestamptz not null default current_timestamp,
 misc jsonb default '{}' not null,
 constraint order_events_pk primary key (order_id, status_event)
);

create table fd.order_menuitem (
 order_id integer not null references fd.order(order_id),
 menuitem_id integer not null references fd.menuitem(menuitem_id),
 quantity numeric, 
 misc jsonb default '{}' not null,
 constraint order_menuitem_pk primary key (order_id, menuitem_id)
);
```
<img width="934" height="753" alt="image" src="https://github.com/user-attachments/assets/4de1b8ec-ae47-4159-b81e-91af0f1475f0" />  

#### Expected revenue and delivery list (the internal query of the CTE)  
```sql
with t as (
 select c.name, 
		coalesce (o.price, (
					select m.price * om.quantity  from fd.order_menuitem as om
					join fd.order as io using(order_id)
					join fd.menuitem as m using(menuitem_id) 
					where io.order_id = o.order_id
				 )) as amount_due, 
		coalesce(o.delivery_address, c.delivery_address) as delivery_address,
		c.name, c.telephone
		from fd.order as o
		join fd.client as c using(client_id)
		where o.effective_date = current_date
)
select SUM(amount_due) from t;
```   
#### Purchase list   
```sql
select p.name, SUM(dp.quantity * mi.quantity)
from fd.order as o
join fd.order_menuitem as mi using (order_id)
join fd.menuitem using (menuitem_id)
join fd.dish using (dish_id)
join fd.dish_product as dp using (dish_id)
join fd.product as p using (product_id)
where o.effective_date = fd.next_wd(current_date)
group by p.product_id;
```
