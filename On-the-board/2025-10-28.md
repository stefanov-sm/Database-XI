## Conditional aggregation
#### and basic SQL `COPY` usage
- create a table with RMS Titanic passengers' list
```sql
CREATE TABLE titanic
(
 passenger_id integer primary key,
 survived boolean,
 pclass smallint,
 name text,
 sex text,
 age numeric,
 sib_sp smallint,
 parch smallint,
 ticket text,
 fare numeric,
 cabin text,
 embarked char(1)
);
```
- populate the table with data from a Titanic passengers' list [CSV file](https://github.com/datasciencedojo/datasets/blob/master/titanic.csv) stored as `c:/temp/titanic/titanic.csv`
```sql
copy titanic from 'c:/temp/titanic/titanic.csv' with 
(
 format 'csv',
 delimiter ',',
 quote '"',
 header 'true'
);
```
> [!note]
> Have a look at PostgreSQL [COPY](https://www.postgresql.org/docs/current/sql-copy.html) documentation  
> Basic but lightning fast Extract-Transform-Load (ETL) and more
#### Now some deep digging
- what is the rate of survival and the average age of survivors per passenegr class and the average age overall
```sql
select case pclass when 1 then 'rich people' when 2 then 'common folk' else 'poor guys' end,
SUM(case when survived then 1 else 0 end)::numeric/COUNT(*)*100 as survival_rate,
AVG(case when survived then age else null end) as avg_age_survivors,
AVG(age) as avg_age_overall
from titanic
group by pclass;
```
- the same but using a reference table for `pclass` and a PostgreSQL-specific `FILTER` clause fore conditional aggregation
```sql
create table passenger_classes (
pclass integer check(pclass between 1 and 3),
class_name text
);
insert into passenger_classes(pclass, class_name)
values (1, 'rich people'), (2, 'common folk'), (3, 'poor guys');

select class_name,
  (SUM(1) filter (where survived)::numeric/COUNT(*)*100)::numeric (10,2) as survival_rate,
  AVG(age) filter (where survived) as avg_age_survivors,
  AVG(age) as avg_age_overall
from titanic join passenger_classes using (pclass)
group by pclass;
```
- Try to do the same without creating the `passenger_classes` reference table but instead a CTE (`WITH` clause) in order to not pollute the database
> [!important]
> **Formatting query results for presentation purposes is bluntly wrong**  
> We only do this for illustration of translation, enums, simple lookups
