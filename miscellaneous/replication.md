## Setup logical replication
### (it turned out to be more tricky than expected)

### A few bits of administration
### On the publisher:
- Edit `postgresql.conf`
```
wal_level = logical
max_replication_slots = 10
max_wal_senders = 10
listen_addresses = '*'
```
- Edit `pg_hba.conf`
```
host  replication  all     0.0.0.0/0        scram-sha-256
host  replication  all     ::0/0            scram-sha-256
```
- Restart PostgreSQL
- Add a firewall rule to allow access to PostgreSQL port (ususally `5432`)
<image src="https://github.com/user-attachments/assets/612161bc-091f-4d12-a227-6b151b9a2284" width=300px>

### On the subscriber:  
- Edit `postgresql.conf`
```
hot_standby = on
```
- Restart PostgreSQL

### And finally SQL
### On the publisher:
```sql
-- create schema if not exists rep;
-- drop table if exists rep.r_table;

create table rep.r_table (
 id integer primary key generated by default as identity, 
 t text, n numeric,
 b boolean default false
);

insert into rep.r_table (t, n) values ('Initial record(s)', 1);
select * from rep.r_table;

-- drop publication if exists tues_pub;

CREATE PUBLICATION tues_pub
FOR TABLE rep.r_table -- , second_table, third_table, ...
WITH (publish = 'insert, update, delete');

insert into rep.r_table (n, t) 
with t(n) as 
(
 select random (100, 2000)
 from generate_series(1, 1000)
)
select n, to_char(n, 'FMRN') t
from t;

update rep.r_table set b = true where id = 3;
```
### On the subscriber:  
```sql
-- create table if not exists rep;
-- drop table if exists rep.r_table;

create table rep.r_table (
 id integer primary key generated by default as identity,
 t text, n numeric,
 b boolean default false
);


-- drop subscription if exists tues_sub;

CREATE SUBSCRIPTION tues_sub
CONNECTION 'host=192.168.1.8 port=5432 dbname=postgres user=postgres password=********'
PUBLICATION tues_pub;

select * from rep.r_table order by id;
```
### Last but not least  
> [!IMPORTANT]    
> See also [REPLICA IDENTITY](https://www.postgresql.org/docs/current/sql-altertable.html#SQL-ALTERTABLE-REPLICA-IDENTITY) 
